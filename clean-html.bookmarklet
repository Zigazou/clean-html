function%20tagSatisfying(tags,element){return%20element.nodeType==Node.ELEMENT_NODE%26%26tags.indexOf(element.nodeName.toLowerCase())!=-1}const%20typographicRules=[[%2F%20%2B%2Fg,%22%20%22],[%2F%27%2Fg,%22%E2%80%99%22],[%2F%20([%3F!%25%E2%82%AC%24%C2%BB%3A%3B])%2Fg,%22%E2%80%89%241%22],[%2F%C2%AB%20%2Fg,%22%C2%AB%C2%A0%22],[%2F%5C.%5C.%5C.%2Fg,%22%E2%80%A6%22],[%2F([0-9])%20%3F([%25%E2%82%AC%24%C2%A3])%2Fg,%22%241%E2%80%89%242%22],[%2F([0-9]{1,3})[%20.]([0-9]{3})[%20.]([0-9]{3})%2Fg,%22%241%242%243%22],[%2F([0-9]{1,3})%20([0-9]{3})%2Fg,%22%241%242%22]]%3Bfunction%20applyTypography(str){for([regex,replacement]of%20typographicRules){str=str.replace(regex,replacement)}return%20str}const%20MAX_WIDTH=600%3Bconst%20MAX_HEIGHT=850%3Bfunction%20cleanTags(fragment){if(isBadTag(fragment))return%20document.createDocumentFragment()%3Blet%20cleaned%3Bif(isUsefulTag(fragment)){cleaned=document.createElement(fragment.nodeName)%3Bfor(const%20attribute%20of%20fragment.attributes){if(!isUsefulAttribute(attribute))continue%3Bcleaned.setAttributeNode(attribute.cloneNode())}if(isAnImage(fragment)){convertImage(fragment.getAttribute(%22src%22),(src,width,height)=%3E{if(width%3Eheight){if(width%3EMAX_WIDTH){height=(MAX_WIDTH%2Aheight%2Fwidth).toPrecision(5)%3Bwidth=MAX_WIDTH}}else{if(height%3EMAX_HEIGHT){width=(MAX_HEIGHT%2Awidth%2Fheight).toPrecision(5)%3Bheight=MAX_HEIGHT}}cleaned.setAttribute(%22width%22,width)%3Bcleaned.setAttribute(%22height%22,height)%3Bcleaned.setAttribute(%22src%22,src)})}else%20if(isALink(fragment)){cleaned.setAttribute(%22href%22,new%20URL(fragment.getAttribute(%22href%22),fragment.baseURI).href)%3Bif(fragment.innerText==%22%22%26%26fragment.getAttribute(%22title%22)!=%22%22){cleaned.innerText=fragment.getAttribute(%22title%22)}}}else%20if(fragment.nodeType==Node.TEXT_NODE){cleaned=document.createTextNode(applyTypography(fragment.data))}else%20if(shouldBeReplaced(fragment)){cleaned=document.createElement(replaceTagBys[fragment.nodeName.toLowerCase()])}else{cleaned=document.createDocumentFragment()}for(const%20child%20of%20fragment.childNodes){cleaned.appendChild(cleanTags(child))}if(isEmptyButShouldNot(cleaned))return%20document.createDocumentFragment()%3Breturn%20cleaned}function%20convertImage(src,callback){const%20image=new%20Image%3Bimage.crossOrigin=%22Anonymous%22%3Bimage.onload=function(){const%20canvas=document.createElement(%22canvas%22)%3Bconst%20context=canvas.getContext(%222d%22)%3Bcanvas.width=this.naturalWidth%3Bcanvas.height=this.naturalHeight%3Bcontext.drawImage(this,0,0)%3Bconst%20dataURL=canvas.toDataURL(%22image%2Fpng%22)%3Bcallback(dataURL,this.naturalWidth,this.naturalHeight)}%3Bimage.src=src}function%20createPopup(fragment){const%20copyTab=window.open(%22%22,%22_blank%22,%22popup%22).document%3BcopyTab.title=%22CleanHTML%22%3BcopyTab.body.appendChild(fragment)%3BcopyTab.close()}const%20isALink=element=%3E{return%20tagSatisfying([%22a%22],element)%26%26element.hasAttribute(%22href%22)}%3Bconst%20isAnImage=element=%3EtagSatisfying([%22img%22],element)%3Bconst%20badTags=[%22script%22,%22noscript%22,%22style%22,%22base%22,%22head%22,%22link%22,%22title%22,%22source%22]%3Bconst%20isBadTag=element=%3EtagSatisfying(badTags,element)%3Bconst%20shouldNotBeEmpty=[%22ul%22,%22ol%22,%22li%22]%3Bconst%20isEmptyButShouldNot=element=%3E{return%20tagSatisfying(shouldNotBeEmpty,element)%26%26element.innerText==%22%22}%3Bconst%20usefulAttributes=[%22href%22,%22src%22,%22alt%22]%3Bfunction%20isUsefulAttribute(attribute){return%20usefulAttributes.indexOf(attribute.name.toLowerCase())!=-1}const%20usefulTags=[%22p%22,%22h1%22,%22h2%22,%22h3%22,%22h4%22,%22h5%22,%22h6%22,%22strong%22,%22em%22,%22ul%22,%22ol%22,%22li%22,%22sup%22,%22sub%22,%22a%22,%22img%22,%22pre%22,%22blockquote%22,%22cite%22,%22address%22,%22dd%22,%22dl%22,%22dt%22,%22hr%22]%3Bconst%20isUsefulTag=element=%3EtagSatisfying(usefulTags,element)%3Bconst%20replaceTagBys={figcaption%3A%22p%22,div%3A%22p%22}%3Bfunction%20shouldBeReplaced(element){return%20element.nodeType==Node.ELEMENT_NODE%26%26element.nodeName.toLowerCase()in%20replaceTagBys}const%20selection=window.getSelection()%3Bif(selection.rangeCount%3E=1){const%20elements=document.createDocumentFragment()%3Bfor(let%20i=0%3Bi%3Cselection.rangeCount%3Bi%2B%2B){elements.appendChild(window.getSelection().getRangeAt(i).cloneContents())}createPopup(cleanTags(elements))}%0A